<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Darkzide TV</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --blue:#0d47a1; --blue-dark:#082d66; --tile:#1565c0; --tile-hover:#1e72cf; --text:#fff; --muted:#d0e0ff; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--blue-dark);color:var(--text)}
    header{padding:16px;background:var(--blue);display:flex;align-items:baseline;gap:12px;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:20px;font-weight:700} header #count{font-size:14px;color:var(--muted);margin-left:auto}
    main{padding:16px}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:var(--tile);border-radius:12px;padding:16px 12px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.35);transition:background .15s,transform .1s;min-height:160px}
    .card:hover{background:var(--tile-hover);transform:translateY(-1px)}
    .logo{width:72px;height:72px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}
    .name{text-align:center;font-weight:700;color:var(--text);line-height:1.2}
    #error{display:none;margin:12px 16px;padding:12px;border-radius:8px;background:#b00020;color:#fff;font-size:14px}
    #playerOverlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:50}
    #playerWrap{position:relative;width:90vw;max-width:1200px;aspect-ratio:16/9}
    #video{width:100%;height:100%;background:#000}
    #closeBtn{position:absolute;top:-40px;right:0;background:var(--blue);color:var(--text);border:none;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <h1>Darkzide TV</h1>
    <div id="count">Loading channelsâ€¦</div>
  </header>
  <div id="error"></div>
  <main><section id="grid" aria-label="Channel grid"></section></main>
  <div id="playerOverlay"><div id="playerWrap"><video id="video" controls playsinline></video><button id="closeBtn">Close</button></div></div>

  <script>
    // Use your raw playlist at the repo root
    const PLAYLIST_URL = 'https://raw.githubusercontent.com/Darkzide-inc/Darkzide-tv/main/newchannels.m3u';
    const FALLBACK_LOGO = '';

    const grid = document.getElementById('grid');
    const countEl = document.getElementById('count');
    const errorEl = document.getElementById('error');
    const overlay = document.getElementById('playerOverlay');
    const video = document.getElementById('video');
    const closeBtn = document.getElementById('closeBtn');

    function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; }
    async function fetchText(url){ const res = await fetch(url, { cache: 'no-store' }); if(!res.ok) throw new Error('HTTP '+res.status); return await res.text(); }

    function parseM3U(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const channels = [];
      for(let i=0;i<lines.length;i++){
        const line = lines[i];
        if(!line.startsWith('#EXTINF')) continue;
        const attrs = {};
        const rgx = /(\w+(?:-\w+)*)\s*=\s*"([^"]*)"/g;
        let m; while((m = rgx.exec(line)) !== null){ attrs[m[1]] = m[2]; }
        const commaIdx = line.lastIndexOf(',');
        const name = commaIdx >= 0 ? line.slice(commaIdx+1).trim() : (attrs['tvg-name'] || 'Channel');
        const url = (i+1 < lines.length) ? lines[i+1] : '';
        const logo = attrs['tvg-logo'] || FALLBACK_LOGO;
        channels.push({ name, url, logo, group: attrs['group-title'] || '' });
        i++;
      }
      return channels;
    }

    function render(channels){
      grid.innerHTML = '';
      channels.forEach(ch=>{
        const card = document.createElement('div'); card.className='card'; card.title=ch.name;
        if(ch.logo){ const img = document.createElement('img'); img.className='logo'; img.src=ch.logo; img.alt=ch.name+' logo'; card.appendChild(img); }
        const name = document.createElement('div'); name.className='name'; name.textContent=ch.name; card.appendChild(name);
        card.addEventListener('click', ()=> playChannel(ch.url));
        grid.appendChild(card);
      });
      countEl.textContent = channels.length + ' channels';
    }

    function playChannel(url){
      if(!url) return;
      overlay.style.display = 'flex';
      const isHls = /\.m3u8(\?|$)/i.test(url);
      if(isHls && Hls.isSupported()){
        const hls = new Hls({ enableWorker: true });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
      } else {
        video.src = url;
        video.play().catch(()=>{});
      }
    }

    function closePlayer(){ video.pause(); video.removeAttribute('src'); video.load(); overlay.style.display='none'; }
    closeBtn.addEventListener('click', closePlayer);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closePlayer(); });

    (async function init(){
      try { const text = await fetchText(PLAYLIST_URL); const channels = parseM3U(text); if(!channels.length){ showError('No channels found.'); } render(channels); }
      catch(err){ showError('Failed to load playlist: ' + err.message); }
    })();
  </script>
</body>
</html>